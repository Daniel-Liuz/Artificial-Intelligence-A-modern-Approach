在本章中，我们不再将状态视为不可分割的“黑盒”，而是采用**因子化表示**（factored representation），将每个状态表示为一组变量，每个变量有自己的值。若所有变量的值满足其约束，则问题求解完毕。这样的形式化问题称为 **约束满足问题（Constraint Satisfaction Problem，CSP）**。

## 6.1 定义约束满足问题

约束满足问题(CSP)由 3 个部分组成，即 X、D 和 C。

- **X** 是变量集合，{X1, …, Xn}。
- **D** 是域集合，{D1, …, Dn}，每个变量有一个域。
(例如，布尔变量的域为{${true}, {false}$}。)
- **C** 是约束集合，由 ⟨scope,rel⟩对组成。

不同变量可以有不同大小的域。每个约束$C_j$ 由 ⟨scope,rel⟩对组成，其中 scope 是该约束中的变量元组，而 rel 定义了这些值应该满足的关系（relation）。

例如，如果 $X_1$和$X_2$的域都是 $\{1, 2, 3\}$，那么约束“$X_1$必须大于$X_2$”可以表示为

$⟨(X1,X2),{(3,1),(3,2),(2,1)}⟩$

或

$⟨(X1,X2),X1>X2⟩$

### 一致与解的定义

在 CSP 中，我们会给每个变量分配一个值，而我们希望这些值满足约束条件。

1. **一致赋值（consistent assignment）**：指在给定的赋值中，没有任何一个变量的值违反了约束条件。换句话说，给定的赋值没有冲突。
    
    例如，如果我们有约束“`X1` 必须大于 `X2`”，并且给定赋值 `X1 = 3` 和 `X2 = 2`，这就是一致赋值，因为 `X1 > X2` 符合约束。
    
2. **完整赋值（complete assignment）**：指每个变量都有一个值被赋予，而不是部分变量没有赋值。
    
    例如，如果有三个变量 `X1`、`X2` 和 `X3`，并且它们都有被赋予的值，那么这就是一个完整赋值。如果只有 `X1` 和 `X2` 被赋值，而 `X3` 没有值，那么这不是完整赋值。
    
3. **解（solution）**：一个解是一个完整且一致的赋值，即所有变量都有值，并且这些值满足所有约束条件。
    
    例如，假设我们有三个变量 `X1`、`X2` 和 `X3`，以及一系列约束。如果我们找到了一个赋值方案，`X1 = 2`，`X2 = 1`，`X3 = 3`，并且这些值满足所有约束，那么这个赋值方案就是一个解。
    
4. **部分解（partial solution）**：部分解是指一些变量已经被赋值且这些赋值是合法的，但并没有给所有变量赋值。
    
    例如，如果有四个变量 `X1`、`X2`、`X3` 和 `X4`，并且给了 `X1` 和 `X2` 赋值，而 `X3` 和 `X4` 还没有被赋值，这就是一个部分解。

CSP 是 NP 完全问题，但某些子类问题可以高效求解。

---
### 6.1.1 示例：地图着色问题

以澳大利亚地图为例：

- 变量：州和地区 `X = {WA, NT, Q, NSW, V, SA, T}`
- 域：`D = {red, green, blue}`
- 约束：相邻区域颜色必须不同

图示如下：
![[6-1澳大利亚地图.png]]
#### 约束集合
由于相邻区域的边界线有 9 段，所以有 9 个约束。我们可以将这些约束表示为：
```scss
C = {
  SA-WA, SA-NT, SA-Q, SA-NSW, SA-V,
  WA-NT, NT-Q, Q-NSW, NSW-V
}
```
这里我们使用了缩写。

例如，`SA-WA` 是 `((SA, WA), SA-WA)` 的缩写，其中 `SA-WA` 代表了 SA 和 WA 这两个相邻区域之间的约束。它的完整枚举可以表示为：
```scss
{(red, green), (red, blue), (green, red), (green, blue), (blue, red), (blue, green)}
```
这个约束的意思是，`SA` 和 `WA` 这两个区域的颜色必须不同，因此可以有六种合法的 `(SA, WA)` 组合。
#### 一个可能的解

通过给定合理的赋值，我们可以找到多个可能的解。一个示例解是：
```scss
{WA = red, NT = green, Q = red, NSW = green, V = red, SA = blue, T = red}
```
#### 约束图的可视化

将 CSP 可视化为 **约束图**（constraint graph）非常有用，图中的节点代表问题的变量，而图的边则连接那些受到同一约束的变量。约束图能帮助我们更直观地理解各个变量之间的约束关系。

图 6-1b（已展示）是澳大利亚地图着色问题的约束图，图中的每个节点表示一个区域，每条边表示相邻区域的约束。
![[6-1澳大利亚地图.png]]

#### 优势

在原子的状态空间搜索中，我们只能问：这个特定状态是目标状态吗？不是？那么这一个呢？
使用 CSP，**一旦发现某个部分赋值违反了约束，我们可以马上放弃对该部分赋值的进一步改进**。此外，我们可以看出为什么某个赋值不是解——可以看出哪些变量违反了约束——从而把注意力集中在关键变量上。因此，许多原子状态空间搜索难以求解的问题形式化为 CSP 后都可以快速求解。

例如，如果我们没有约束条件的话，必须考虑这 5 个相邻变量的所有 243 种可能赋值（即 `5^3 = 243`）。然而，由于有了约束条件，我们只需考虑 32 种赋值（即 `2^5 = 32`），计算量减少了 87%。

### 6.1.2 问题示例：车间作业调度
工厂中的许多日常工作调度问题涉及到各种约束条件。在实际应用中，CSP 技术可以用来求解这类问题。以下是一个具体的汽车装配调度问题。
#### 问题背景

假设一个工厂的汽车装配过程中涉及多个任务。这些任务包括安装轮轴、固定车轮、拧紧螺母、安装轮毂盖以及最终的检查等。每个任务都有一个开始时间，并且有着各种优先级约束和资源限制。

在这个问题中，我们将每个任务建模为一个变量，任务的开始时间由整数分钟数表示。

#### 任务及其变量

为了简化问题，假设整个装配过程包括 15 个任务。我们将每个任务表示为一个变量，其开始时间是这个任务的值：
```ini
X = {AxleF, AxleB, WheelRF, WheelLF, WheelRB, WheelLB, NutsRF, NutsLF, NutsRB, NutsLB, CapRF, CapLF, CapRB, CapLB, Inspect}
```
这些任务包括：
- **AxleF**：前轮轮轴            **AxleB**：后轮轮轴
- **WheelRF**：右前轮          **WheelLF**：左前轮
- **WheelRB**：右后轮          **WheelLB**：左后轮
- **NutsRF**：右前轮螺母      **NutsLF**：左前轮螺母
- **NutsRB**：右后轮螺母      **NutsLB**：左后轮螺母
- **CapRF**：右前轮轮毂盖    **CapLF**：左前轮轮毂盖
- **CapRB**：右后轮轮毂盖    **CapLB**：左后轮轮毂盖
- **Inspect**：最终检查
#### 任务间的优先约束

在这些任务中，某些任务必须在其他任务之前完成。比如，轮轴必须在车轮安装之前完成，而每个任务也有其所需的时间。

1. **安装轮轴**：假设安装每个轮轴需要 10 分钟，那么对于前轮轮轴（`AxleF`）和后轮轮轴（`AxleB`），我们有如下的算术约束：
```nginx
AxleF + 10 ≤ WheelRF
AxleF + 10 ≤ WheelLF
AxleB + 10 ≤ WheelRB
AxleB + 10 ≤ WheelLB
```
2. **固定车轮**：每个车轮的安装需要 1 分钟，安装轮毂盖需要 1 分钟，拧紧螺母需要 2 分钟。相应的约束如下：
```nginx
WheelRF + 1 ≤ NutsRF
NutsRF + 2 ≤ CapRF
WheelLF + 1 ≤ NutsLF
NutsLF + 2 ≤ CapLF
WheelRB + 1 ≤ NutsRB
NutsRB + 2 ≤ CapRB
WheelLB + 1 ≤ NutsLB
NutsLB + 2 ≤ CapLB
```
  3. **检查任务**：检查是最后一个任务，需花费 3 分钟。因此，我们需要为除 `Inspect` 任务 外的每个任务添加如下约束：
```nginx
X + 3 ≤ Inspect
```
#### 资源限制与析取约束

在这个车间调度问题中，我们有 4 个工人来安装车轮，但他们必须共用一个工具来安装轮轴。因此，我们需要添加析取约束（disjunctive constraint），表示轮轴任务之间不能重叠。

具体来说，`AxleF` 和 `AxleB` 必须顺序进行，要么先做 `AxleF`，要么先做 `AxleB`，不能同时进行。这个约束可以表示为：
```scss
(AxleF + 10 ≤ AxleB) 或 (AxleB + 10 ≤ AxleF)
```
这种约束结合了算术约束和逻辑约束，但仍然可以简化为 `AxleF` 和 `AxleB` 可以取的时间值组合。
#### 时间限制

假设我们需要在 30 分钟内完成整个装配任务。因此，所有变量的域被限制为：
```ini
Di = {0, 1, 2, 3, …, 30}
```
这意味着每个任务的开始时间必须在 0 到 30 分钟之间。
#### 总结
虽然这个问题的求解过程较为繁琐，但 CSP 技术成功地应用于这类具有大量变量和复杂约束的车间作业调度问题。CSP 的优势在于，它能够自然地表示各种调度问题，并通过约束消除大量无效的搜索空间，显著提高求解效率。
### 6.1.3 CSP 形式体系的变体
CSP 问题可以根据变量和约束的类型进行分类。最简单的 CSP 涉及离散有限域（discrete, finite domain）的变量，例如地图着色问题和带有时间限制的调度问题。
#### 离散有限域 CSP

例如，**八皇后问题**也可以视为一个有限域 CSP，其中每个变量表示棋盘上的一列皇后。每个变量的域是该列中皇后可能的行号，`Di = {1, 2, 3, ..., 8}`。约束为：两个皇后不能位于同一行或同一对角线上。
![[4-3八皇后问题.png]]
#### 无限域 CSP

离散域有时也可以是无限的，比如整数集或字符串集。例如，若调度问题没有截止时间要求，则每个任务的开始时间可以是一个无限集合。
在处理无限域时，通常需要使用 **隐式约束**（如 `T1 + d1 ≤ T2`），而非显式列出所有可能值的元组。(因为无法枚举，是无限解)
#### 连续域 CSP

**连续域 CSP** 常见于现实世界中，并且在运筹学领域得到广泛应用。例如，哈勃太空望远镜的调度问题，涉及精确的观测时间，每次观测和机动的开始与结束时间为连续变量，且需要满足一系列天文、优先级和电力约束。

最著名的连续域 CSP 是 **线性规划** 问题。其约束是线性等式或不等式，可以在多项式时间内求解。其他相关问题还包括二次规划、二阶锥规划等，这些都构成了应用数学的重要领域。

#### 约束类型

1. **一元约束**：限制单个变量的值。例如，在地图着色问题中，南澳大利亚州不允许为绿色，我们可以用一元约束表示为 `〈(SA), SA ≠ green〉`。
    
2. **二元约束**：涉及两个变量。例如，“SA”与“NSW”之间的约束就是二元约束，可以表示为相邻区域的颜色约束。
    
3. **高阶约束**：涉及多个变量的约束。例如，三元约束 `Between(X, Y, Z)` 可以定义为 `〈(X, Y, Z), X ≠ Y ≠ Z〉`。
    
4. **全局约束**：涉及多个变量的约束。例如，**Alldiff** 约束要求所有涉及的变量值必须不同。在数独问题中，一行、一列或 3×3 的方格中的所有变量必须满足此约束。
    

#### 密码算术谜题示例

一个典型的全局约束示例是 **密码算术谜题**（图 6-2a）。在这个问题中，每个字母代表一个不同的数字，目的是找到使加法算式成立的代替字母的数字，且不允许前导零。以下是密码算术谜题的约束：

- 约束关系如 `O + O = R + 10*C1`、`C1 + W + W = U + 10*C2` 等，其中 `C1`、`C2` 和 `C3` 是辅助变量，表示进位数。

这些约束可以用 **约束超图**（constraint hypergraph）表示，如图 6-2b 所示。